<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" xmlns:xsd="http://www.w3.org/2001/XMLSchema" targetNamespace="http://www.activiti.org/processdef" exporter="Camunda Modeler" exporterVersion="3.4.1">
  <process id="renewal-process-example" name="Renewal Process Example" isExecutable="true">
    <extensionElements>
      <camunda:executionListener delegateExpression="${renewalStateListener}" event="start" />
    </extensionElements>
    <sequenceFlow id="startToGetDays" sourceRef="startEvent" targetRef="getRemainingDays" />
    <sequenceFlow id="getDaysToNDaysDecision" sourceRef="getRemainingDays" targetRef="noticeDecision" />
    <exclusiveGateway id="finalNoticeDecision" name="Final Notice Sent">
      <documentation>Checks if the final notice has been sent? Go to Send Final Notice if No. Go to Notify Property Manager if final notice sent. Note that the worklfow goes through one more cycle giving the tenant final chance to reply.</documentation>
    </exclusiveGateway>
    <sequenceFlow id="finalNoticeToSendFinalNotice" name="No" sourceRef="finalNoticeDecision" targetRef="send-final-notice">
      <conditionExpression xsi:type="tFormalExpression">${finalNoticeSent == false}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="finalNoticeDecisionToNotifiyAdmin" name="Yes" sourceRef="finalNoticeDecision" targetRef="notifyPropertyManager">
      <conditionExpression xsi:type="tFormalExpression">${finalNoticeSent == true}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="sendFinalNoticeToAwaitTenantReply" sourceRef="send-final-notice" targetRef="awaitTenantReply" />
    <exclusiveGateway id="noticeDecision" name="Remaining Days?">
      <documentation>Check the number of days the workflow has existed. If less than specified N days then go to Send Initial Tenant Message Task. If N days or older go to the Final Notice Decision.</documentation>
    </exclusiveGateway>
    <sequenceFlow id="noticeDecisionToFinalNoticeDecision" name="&#60;=0" sourceRef="noticeDecision" targetRef="finalNoticeDecision">
      <conditionExpression xsi:type="tFormalExpression">${remainingDays &lt;= 0}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="noticeDecisionToSendInitalTenantMessage" name="&#62;0" sourceRef="noticeDecision" targetRef="send-inital-message">
      <conditionExpression xsi:type="tFormalExpression">${remainingDays &gt; 0}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="sendInitalTenantMessageToAwaitTenantReply" sourceRef="send-inital-message" targetRef="awaitTenantReply" />
    <boundaryEvent id="gracePeriodTimer" attachedToRef="awaitTenantReply">
      <timerEventDefinition>
        <timeCycle>${gracePeriod}</timeCycle>
      </timerEventDefinition>
    </boundaryEvent>
    <sequenceFlow id="tenantReplyToReplyDecision" sourceRef="awaitTenantReply" targetRef="notifyPropertyManager" />
    <sequenceFlow id="gracePeriodTimerToGetWorkflowDays" sourceRef="gracePeriodTimer" targetRef="getRemainingDays" />
    <sequenceFlow id="notifyPropertyManagerToConfrimRenewalState" sourceRef="notifyPropertyManager" targetRef="confrimRenewalState" />
    <sequenceFlow id="confirmRenewalStateToRenewalStateDecision" sourceRef="confrimRenewalState" targetRef="renewalStateDecision" />
    <exclusiveGateway id="renewalStateDecision" name="Renewal Confirmed">
      <documentation>If the renewal state is set to &lt;confirmed&gt; the workfow goes to the Send Tenant Confirmation task and sends the message from the property manager. If the &lt;renewal state&gt; is set to &lt;not confirmed&gt; the workflow will go to Send Tenant Message sending the message input by the property manager.</documentation>
    </exclusiveGateway>
    <sequenceFlow id="renewalStateDecisionToSendTenantMessage" name="No" sourceRef="renewalStateDecision" targetRef="sendTenantMessage">
      <conditionExpression xsi:type="tFormalExpression">${renewalConfirmed == false}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="renewalStateDecisionToSendTenantConfirmation" name="Yes" sourceRef="renewalStateDecision" targetRef="sendTenantConfirmation">
      <conditionExpression xsi:type="tFormalExpression">${renewalConfirmed == true}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="sendTenantMessageToAwaitTenantReply" sourceRef="sendTenantMessage" targetRef="awaitTenantReply" />
    <sequenceFlow id="sendTenantConfirmationToEnd" sourceRef="sendTenantConfirmation" targetRef="end" />
    <endEvent id="end" />
    <sendTask id="sendTenantMessage" name="Send Tenant Message" camunda:asyncBefore="true" camunda:delegateExpression="${logger}">
      <documentation>Sends the message input by the property manager in the Confirm Renewal State task.</documentation>
      <incoming>renewalStateDecisionToSendTenantMessage</incoming>
      <outgoing>sendTenantMessageToAwaitTenantReply</outgoing>
    </sendTask>
    <sendTask id="notifyPropertyManager" name="Notify Property Manager" camunda:asyncBefore="true" camunda:delegateExpression="${logger}">
      <documentation>Notify Property Manager the tenant has replied.</documentation>
      <incoming>finalNoticeDecisionToNotifiyAdmin</incoming>
      <incoming>tenantReplyToReplyDecision</incoming>
      <outgoing>notifyPropertyManagerToConfrimRenewalState</outgoing>
    </sendTask>
    <userTask id="confrimRenewalState" name="Confirm Renewal State">
      <documentation>Property Manager replies to users based on the users last response and sets the &lt;renewal state&gt; variable. If the renewal state is set to &lt;confirmed&gt; the workfow goes to the Send Tenant Confirmation task and sends the message from the Property Manager. If the &lt;renewal state&gt; is set to &lt;not confirmed&gt; the workflow will go to Send Tenant Message sending the message input by the property manager.
The propery manager at this stage makes the final decision on weather the workflow should contine or not. It's possible a final notice has been and the &lt;grace period&gt; has expired but the property manager can choose to start the grace period over by setting the &lt;renewal state&gt; to not confimerd. 
May want to include the ability to change the grace period.</documentation>
      <extensionElements>
        <camunda:executionListener delegateExpression="${renewalStateListener}" event="start" />
      </extensionElements>
      <incoming>notifyPropertyManagerToConfrimRenewalState</incoming>
      <outgoing>confirmRenewalStateToRenewalStateDecision</outgoing>
    </userTask>
    <sendTask id="sendTenantConfirmation" name="Send Tenant Confirmation" camunda:asyncBefore="true" camunda:delegateExpression="${logger}">
      <documentation>Sends the confirmation input by property manager in the Confirm Renewal Task.</documentation>
      <incoming>renewalStateDecisionToSendTenantConfirmation</incoming>
      <outgoing>sendTenantConfirmationToEnd</outgoing>
    </sendTask>
    <sendTask id="send-final-notice" name="Send Final Notice" camunda:asyncBefore="true" camunda:delegateExpression="${logger}">
      <documentation>Sends final notice to tenant. Once final notice is sent there is a 24 hr &lt;grace period&gt; set. If user does not reply the property manager is notified and the manager can choose to send set the &lt;renewal state&gt; to confirmed or give the tenant another chance and reset the &lt;grace period&gt; and the set  the &lt;renewal state&gt; to not confirmed in the Confirm Renewal State task.</documentation>
      <incoming>finalNoticeToSendFinalNotice</incoming>
      <outgoing>sendFinalNoticeToAwaitTenantReply</outgoing>
    </sendTask>
    <receiveTask id="awaitTenantReply" name="Await Tenant Reply" messageRef="Message_0jc16nv">
      <documentation>Waits for the tenant to reply to message. If no reply within &lt;grace period&gt; go back to check the &lt;final renewal date&gt;. If tenant replies than property manager is notified immediatly.
        Calculate the &lt;grace period&gt; based on the &lt;final renewal day&gt;. The workflow should stagger the messages depending on the number of days left until &lt;final renewal day&gt;. Also the property manager can set the &lt;grace period&gt;, overriding the stagger. The override is done by property manager in Confirm Renewal State task.
        TODO - Document how this will be done in more detail.</documentation>
      <extensionElements>
        <camunda:executionListener delegateExpression="${renewalStateListener}" event="start" />
      </extensionElements>
      <incoming>sendInitalTenantMessageToAwaitTenantReply</incoming>
      <incoming>sendTenantMessageToAwaitTenantReply</incoming>
      <incoming>sendFinalNoticeToAwaitTenantReply</incoming>
      <outgoing>tenantReplyToReplyDecision</outgoing>
    </receiveTask>
    <sendTask id="send-inital-message" name="Send Initial Message" camunda:asyncBefore="true" camunda:delegateExpression="${logger}">
      <documentation>Sends a canned tenant message to initiate the renewal process. This message is sent until there is a reply from tenant.</documentation>
      <incoming>noticeDecisionToSendInitalTenantMessage</incoming>
      <outgoing>sendInitalTenantMessageToAwaitTenantReply</outgoing>
    </sendTask>
    <serviceTask id="getRemainingDays" name="Calculate Remaining Days" camunda:delegateExpression="${getRemainingDaysDelegate}">
      <incoming>startToGetDays</incoming>
      <incoming>gracePeriodTimerToGetWorkflowDays</incoming>
      <outgoing>getDaysToNDaysDecision</outgoing>
    </serviceTask>
    <startEvent id="startEvent" name="Start">
      <outgoing>startToGetDays</outgoing>
    </startEvent>
  </process>
  <message id="Message_0jc16nv" name="tenant_reply_message" />
  <bpmndi:BPMNDiagram id="BPMNDiagram_renewalRenewal">
    <bpmndi:BPMNPlane id="BPMNPlane_renewalRenewal" bpmnElement="renewal-process-example">
      <bpmndi:BPMNShape id="BPMNShape_finalNoticeDecision" bpmnElement="finalNoticeDecision" isMarkerVisible="true">
        <omgdc:Bounds x="442" y="180" width="40" height="40" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="348" y="193" width="84" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_noticeDecision" bpmnElement="noticeDecision" isMarkerVisible="true">
        <omgdc:Bounds x="442" y="326" width="40" height="40" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="418.5" y="376" width="87" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_gracePeriodTimer" bpmnElement="gracePeriodTimer">
        <omgdc:Bounds x="934" y="371" width="30" height="30" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="904" y="268" width="90" height="20" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_renewalStateDecision" bpmnElement="renewalStateDecision" isMarkerVisible="true">
        <omgdc:Bounds x="1409" y="326" width="40" height="40" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="1404" y="284" width="51" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_end" bpmnElement="end">
        <omgdc:Bounds x="1686" y="328" width="35" height="35" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="1659" y="243" width="90" height="20" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="BPMNEdge_startToGetDays" bpmnElement="startToGetDays">
        <omgdi:waypoint x="190" y="346" />
        <omgdi:waypoint x="262" y="346" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="181" y="201" width="90" height="20" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_getDaysToNDaysDecision" bpmnElement="getDaysToNDaysDecision">
        <omgdi:waypoint x="362" y="346" />
        <omgdi:waypoint x="442" y="346" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="357" y="201" width="90" height="20" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_finalNoticeToSendFinalNotice" bpmnElement="finalNoticeToSendFinalNotice">
        <omgdi:waypoint x="482" y="200" />
        <omgdi:waypoint x="630" y="200" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="536" y="174" width="14" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_finalNoticeDecisionToNotifiyAdmin" bpmnElement="finalNoticeDecisionToNotifiyAdmin">
        <omgdi:waypoint x="462" y="180" />
        <omgdi:waypoint x="462" y="100" />
        <omgdi:waypoint x="1118" y="100" />
        <omgdi:waypoint x="1118" y="306" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="500" y="82" width="19" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_sendFinalNoticeToAwaitTenantReply" bpmnElement="sendFinalNoticeToAwaitTenantReply">
        <omgdi:waypoint x="730" y="200" />
        <omgdi:waypoint x="949" y="200" />
        <omgdi:waypoint x="949" y="306" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="808.5" y="201" width="90" height="20" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_noticeDecisionToFinalNoticeDecision" bpmnElement="noticeDecisionToFinalNoticeDecision">
        <omgdi:waypoint x="462" y="326" />
        <omgdi:waypoint x="462" y="220" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="440" y="303" width="19" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_noticeDecisionToSendInitalTenantMessage" bpmnElement="noticeDecisionToSendInitalTenantMessage">
        <omgdi:waypoint x="482" y="346" />
        <omgdi:waypoint x="630" y="346" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="503" y="333" width="13" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_sendInitalTenantMessageToAwaitTenantReply" bpmnElement="sendInitalTenantMessageToAwaitTenantReply">
        <omgdi:waypoint x="730" y="346" />
        <omgdi:waypoint x="899" y="346" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="735.5" y="327" width="90" height="20" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_tenantReplyToReplyDecision" bpmnElement="tenantReplyToReplyDecision">
        <omgdi:waypoint x="999" y="346" />
        <omgdi:waypoint x="1069" y="345" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="989" y="200.5" width="90" height="20" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_notifyPropertyManagerToConfrimRenewalState" bpmnElement="notifyPropertyManagerToConfrimRenewalState">
        <omgdi:waypoint x="1169" y="345" />
        <omgdi:waypoint x="1243" y="345" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="1161" y="200" width="90" height="20" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_confirmRenewalStateToRenewalStateDecision" bpmnElement="confirmRenewalStateToRenewalStateDecision">
        <omgdi:waypoint x="1343" y="346" />
        <omgdi:waypoint x="1409" y="346" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="1331" y="201" width="90" height="20" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_renewalStateDecisionToSendTenantMessage" bpmnElement="renewalStateDecisionToSendTenantMessage">
        <omgdi:waypoint x="1429" y="366" />
        <omgdi:waypoint x="1429" y="494" />
        <omgdi:waypoint x="1237" y="494" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="1433" y="369" width="14" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_renewalStateDecisionToSendTenantConfirmation" bpmnElement="renewalStateDecisionToSendTenantConfirmation">
        <omgdi:waypoint x="1449" y="346" />
        <omgdi:waypoint x="1533" y="346" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="1465" y="320" width="19" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_sendTenantMessageToAwaitTenantReply" bpmnElement="sendTenantMessageToAwaitTenantReply">
        <omgdi:waypoint x="1137" y="493" />
        <omgdi:waypoint x="975" y="493" />
        <omgdi:waypoint x="975" y="386" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="1011" y="338" width="90" height="20" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_sendTenantConfirmationToEnd" bpmnElement="sendTenantConfirmationToEnd">
        <omgdi:waypoint x="1633" y="346" />
        <omgdi:waypoint x="1686" y="346" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="1614.5" y="201" width="90" height="20" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_gracePeriodTimerToGetWorkflowDays" bpmnElement="gracePeriodTimerToGetWorkflowDays">
        <omgdi:waypoint x="949" y="401" />
        <omgdi:waypoint x="949" y="480" />
        <omgdi:waypoint x="312" y="480" />
        <omgdi:waypoint x="312" y="386" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="585.5" y="420" width="90" height="20" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="SendTask_0lam0v8_di" bpmnElement="sendTenantMessage">
        <omgdc:Bounds x="1137" y="454" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SendTask_16ksfc6_di" bpmnElement="notifyPropertyManager">
        <omgdc:Bounds x="1069" y="306" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="UserTask_0yky9yq_di" bpmnElement="confrimRenewalState">
        <omgdc:Bounds x="1243" y="306" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SendTask_0bqyixm_di" bpmnElement="sendTenantConfirmation">
        <omgdc:Bounds x="1533" y="306" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SendTask_0jgef82_di" bpmnElement="send-final-notice">
        <omgdc:Bounds x="630" y="161" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ReceiveTask_1aap0e5_di" bpmnElement="awaitTenantReply">
        <omgdc:Bounds x="899" y="306" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SendTask_0zmpm8z_di" bpmnElement="send-inital-message">
        <omgdc:Bounds x="630" y="306" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_0cfhmm1_di" bpmnElement="getRemainingDays">
        <omgdc:Bounds x="262" y="306" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="StartEvent_1tom3ss_di" bpmnElement="startEvent">
        <omgdc:Bounds x="154" y="328" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="160" y="363" width="24" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
